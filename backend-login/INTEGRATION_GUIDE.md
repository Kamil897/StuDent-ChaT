# Руководство по интеграции новых модулей

## Обзор системы

Система была расширена следующими модулями:

1. **Achievements** - система достижений
2. **Friends** - система друзей
3. **Messages** - система сообщений
4. **Wallet** - система кошелька
5. **Analytics** - система аналитики

## База данных

### Новые таблицы
- `Achievement` - достижения
- `UserAchievement` - достижения пользователей
- `Friend` - друзья
- `Message` - сообщения
- `WalletTransaction` - транзакции кошелька

### Обновленные поля User
- `coins` - монеты
- `crystals` - кристаллы

## API Endpoints

### Достижения
- `GET /achievements` - список всех достижений
- `GET /achievements/user` - достижения пользователя
- `POST /achievements/unlock` - открыть достижение
- `POST /achievements/check` - проверить достижения после игры
- `GET /achievements/stats` - статистика достижений

### Друзья
- `POST /friends/add` - добавить в друзья
- `POST /friends/accept` - принять заявку
- `GET /friends` - список друзей
- `GET /friends/pending/requests` - входящие заявки
- `POST /friends/remove` - удалить из друзей
- `POST /friends/block` - заблокировать

### Сообщения
- `POST /messages/send` - отправить сообщение
- `GET /messages/:friendId` - история переписки
- `POST /messages/:id/read` - отметить как прочитанное
- `GET /messages/unread/count` - количество непрочитанных
- `GET /messages/conversations/recent` - последние переписки

### Кошелек
- `GET /wallet/balance` - баланс
- `POST /wallet/add` - пополнить
- `POST /wallet/spend` - потратить
- `POST /wallet/transfer` - перевести другу
- `GET /wallet/transactions` - история транзакций
- `GET /wallet/stats` - статистика

### Аналитика (только для админов)
- `GET /analytics/top-games` - топ игр
- `GET /analytics/active-users` - активные пользователи
- `GET /analytics/sales` - статистика продаж
- `GET /analytics/game/:gameName` - аналитика игры
- `GET /analytics/user/:id` - аналитика пользователя

## Frontend компоненты

### Новые страницы
- `Achievements.jsx` - витрина достижений
- `FriendsList.jsx` - список друзей и заявки
- `ChatBox.jsx` - чат с друзьями
- `Wallet.jsx` - кошелек и транзакции

### Интеграция с играми

#### 1. Сохранение прогресса с проверкой достижений
```javascript
import { saveGameProgress } from '../utils/gamesApi';

// После завершения игры
const gameData = {
  score: 1500,
  level: 5,
  timeSpent: 300,
  completed: true
};

await saveGameProgress('snake', gameData);
// Автоматически проверяются достижения и показываются уведомления
```

#### 2. Уведомления о достижениях
Система автоматически создает уведомления в localStorage при получении достижений.

#### 3. Интеграция с кошельком
```javascript
// Награда за игру
const coinsEarned = Math.floor(score / 10);
await fetch('/wallet/add', {
  method: 'POST',
  headers: { 'Authorization': `Bearer ${token}` },
  body: JSON.stringify({
    amount: coinsEarned,
    currency: 'coins',
    source: 'game_reward'
  })
});
```

## Геймификация

### Система достижений
1. **Автоматическая проверка** - после каждой игры
2. **Уведомления** - показываются при получении
3. **Очки кармы** - начисляются за достижения
4. **Статистика** - отслеживание прогресса

### Социальные функции
1. **Друзья** - добавление, заявки, блокировка
2. **Чат** - обмен сообщениями между друзьями
3. **Сравнение** - результаты друзей в играх
4. **Уведомления** - о достижениях друзей

### Экономика
1. **Монеты** - основная валюта, зарабатывается в играх
2. **Кристаллы** - премиум валюта, покупается за деньги
3. **Карма** - награды за достижения и социальные действия
4. **Переводы** - между друзьями

## Тестирование

### Тестовый сценарий 1: Достижения
1. Игрок заходит в игру Snake
2. Набирает 1000+ очков
3. Получает достижение "Snake Master"
4. Показывается уведомление
5. Начисляются очки кармы

### Тестовый сценарий 2: Социальные функции
1. Игрок добавляет друга по ID
2. Отправляет заявку в друзья
3. Друг принимает заявку
4. Игроки могут обмениваться сообщениями
5. Видят друг друга в списке друзей

### Тестовый сценарий 3: Экономика
1. Игрок выигрывает игру
2. Получает монеты за счет
3. Покупает предмет в магазине
4. Запись сохраняется в истории покупок
5. Отражается в аналитике

## Развертывание

### 1. Миграции базы данных
```bash
npx prisma migrate dev --name add_achievements_friends_messages_wallet
```

### 2. Сборка backend
```bash
npm run build
```

### 3. Запуск сервера
```bash
npm run start:dev
```

### 4. Интеграция frontend
Добавить новые компоненты в роутинг и навигацию.

## Мониторинг

### Логи
- Все транзакции кошелька
- Получение достижений
- Социальные действия
- Ошибки API

### Метрики
- Активность пользователей
- Популярность игр
- Эффективность достижений
- Социальная активность

## Безопасность

### Авторизация
- Все endpoints защищены JWT
- Проверка ролей для аналитики
- Валидация входных данных

### Ограничения
- Только друзья могут обмениваться сообщениями
- Проверка баланса перед покупками
- Защита от дублирования достижений

## Расширение

### Новые типы достижений
Добавить новые условия в `AchievementsService.evaluateCondition()`

### Дополнительные валюты
Расширить модель `WalletTransaction` новыми типами валют

### Социальные функции
Добавить группы, кланы, турниры

### Аналитика
Создать дашборды для администраторов




